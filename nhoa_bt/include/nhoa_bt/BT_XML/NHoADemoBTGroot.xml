<?xml version="1.0"?>
<root main_tree_to_execute="NHoADemoBT">
    <!-- ////////// -->
    <BehaviorTree ID="NHoADemoBT">
        <Sequence>     
            <SubTree ID="T1"/> 
            <ReactiveSequence name="UserDetectionReactiveSequence">
                <Condition ID="IsUserDetected"/>
                <SubTree ID="T2"/> 
                <SubTree ID="T3"/> 
                <SetBlackboard output_key="conversation_mode" value="chit_chat"/>
                <SubTree ID="TConversation" __shared_blackboard="false" _conversation_mode="conversation_mode"/>   
                <SetBlackboard output_key="conversation_mode" value="questionnaire"/>
                <SubTree ID="TConversation" __shared_blackboard="false" _conversation_mode="conversation_mode"/>   
                <SetBlackboard output_key="conversation_mode" value="questionnaire_fb"/>
                <SubTree ID="TConversation" __shared_blackboard="false" _conversation_mode="conversation_mode"/>  
                <SubTree ID="T7"/> 
            </ReactiveSequence>
        </Sequence>    
    </BehaviorTree>
    <!-- ////////// -->
    <BehaviorTree ID="T1">
        <Sequence>        
            <SetBlackboard output_key="motion_name" value="look_around"/>
            <RetryUntilSuccesful num_attempts="30">
                <Fallback>
                    <Condition ID="IsUserDetected"/>
                    <Inverter>
                        <Action ID="ExecuteUperbodyMotion" _motion_name="{motion_name}"/>
                    </Inverter>
                </Fallback>
            </RetryUntilSuccesful>
        </Sequence>
    </BehaviorTree>
    <!-- ////////// -->
    <BehaviorTree ID="T2">
        <Sequence>        
            <SetBlackboard output_key="iteration" value="0"/>
            <RetryUntilSuccesful num_attempts="30">
                <Fallback>
                    <Condition ID="IsUserEngaging"/>
                    <Inverter>
                        <Sequence>        
                            <Action ID="DrawUserAttention" _iteration="{iteration}" iteration_="{iteration}" motion_name_="{motion_name}" voice_cmd_="{voice_cmd}"/>
                            <Parallel success_threshold="2">
                                <Action ID="ExecuteUperbodyMotion" _motion_name="{motion_name}"/>
                                <Action ID="ExecuteVoiceCmd" _voice_cmd="{voice_cmd}"/>
                            </Parallel> 
                        </Sequence>        
                    </Inverter>
                </Fallback>
            </RetryUntilSuccesful>
        </Sequence>
    </BehaviorTree>
    <!-- ////////// -->
    <BehaviorTree ID="T3">
        <Sequence>        
            <SetBlackboard output_key="navigation_goal" value="0.0;1.0;2.0"/>
            <RetryUntilSuccesful num_attempts="30">
                <Fallback>
                    <Condition ID="IsUserEngaged"/>
                    <Inverter> 
                        <Action ID="ExecuteNavigation" _navigation_goal="{navigation_goal}" />
                    </Inverter>
                </Fallback>
            </RetryUntilSuccesful>
        </Sequence>
    </BehaviorTree>
    <!-- ////////// -->
    <BehaviorTree ID="TConversation">
        <Sequence>     
            <SetBlackboard output_key="iteration" value="0"/>   
            <RetryUntilSuccesful num_attempts="30">
                <Fallback>
                    <Inverter>
                        <Sequence>    
                            <Action ID="ExecuteConversation" _conversation_mode="{_conversation_mode}" _iteration="{iteration}" iteration_="{iteration}" motion_name_="" voice_cmd_="{voice_cmd}"/>
                            <Action ID="ExecuteVoiceCmd" _voice_cmd="{voice_cmd}"/>
                        </Sequence>    
                    </Inverter>
                </Fallback>
            </RetryUntilSuccesful>
        </Sequence>
    </BehaviorTree>
    <!-- ////////// -->
    <BehaviorTree ID="T7">
        <Sequence>     
            <SetBlackboard output_key="iteration" value="0"/>   
            <SetBlackboard output_key="conversation_mode" value="agenda_recall"/>   
            <RetryUntilSuccesful num_attempts="30">
                <Inverter>
                    <Sequence>    
                        <Action ID="ExecuteConversation" _conversation_mode="{conversation_mode}" _iteration="{iteration}" iteration_="{iteration}" motion_name_="{motion_name}" voice_cmd_="{voice_cmd}"/>
                        <Action ID="ExecuteVoiceCmd" _voice_cmd="{voice_cmd}"/>
                    </Sequence>    
                </Inverter>
            </RetryUntilSuccesful>
            <Action ID="ExecuteUperbodyMotion" _motion_name="{motion_name}"/>
        </Sequence>
    </BehaviorTree>
    <!-- ////////// -->
    <TreeNodesModel>
        <!-- Action Nodes -->
        <Action ID="ExecuteConversation">
            <input_port name="_conversation_mode" type="std::string"/>
            <input_port name="_iteration" type="std::size_t"/>
            <output_port name="iteration_" type="std::size_t"/>
            <output_port name="motion_name_" type="std::string"/>
            <output_port name="voice_cmd_" type="std::string"/>
        </Action>
        <Action ID="ExecuteNavigation">
            <input_port name="_navigation_goal" type="std::vector&lt;double, std::allocator&lt;double&gt; &gt;"/>
        </Action>
        <Action ID="ExecuteUperbodyMotion">
            <input_port name="_motion_name" type="std::string"/>
        </Action>
        <Action ID="ExecuteVoiceCmd">
            <input_port name="_voice_cmd" type="std::string"/>
        </Action>
        <Action ID="DrawUserAttention">
            <input_port name="_iteration" type="std::size_t"/>
            <output_port name="iteration_" type="std::size_t"/>
            <output_port name="motion_name_" type="std::string"/>
            <output_port name="voice_cmd_" type="std::string"/>
        </Action>
        <!-- Condition Nodes -->
        <Condition ID="IsUserDetected"/>
        <Condition ID="IsUserEngaged"/>
        <Condition ID="IsUserEngaging"/>
        <!-- Subtrees -->
        <SubTree ID="T1">
            <!-- <input_port default="false" name="__shared_blackboard">If false (default), the Subtree has an isolated blackboard and needs port remapping</input_port>
            <input_port default="move_group" name="_move_group"/> -->
        </SubTree>
        <SubTree ID="T2">
            <!-- <input_port default="false" name="__shared_blackboard">If false (default), the Subtree has an isolated blackboard and needs port remapping</input_port>
            <input_port default="move_group" name="_move_group"/> -->
        </SubTree>
        <SubTree ID="T3">
            <!-- <input_port default="false" name="__shared_blackboard">If false (default), the Subtree has an isolated blackboard and needs port remapping</input_port>
            <input_port default="move_group" name="_move_group"/> -->
        </SubTree>
        <SubTree ID="TConversation">
            <input_port default="false" name="__shared_blackboard">If false (default), the Subtree has an isolated blackboard and needs port remapping</input_port>
            <input_port default="conversation_mode" name="_conversation_mode"/>
        </SubTree>
        <SubTree ID="T7">
            <!-- <input_port default="false" name="__shared_blackboard">If false (default), the Subtree has an isolated blackboard and needs port remapping</input_port>
            <input_port default="move_group" name="_move_group"/> -->
        </SubTree>
    </TreeNodesModel>
    <!-- ////////// -->
</root>

